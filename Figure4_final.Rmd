---
title: "Figure4 - old Fig 5"
author: "Athena Golfinos-Owens"
date: "2025-01-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggrepel)
library(ggpubr)
library(dplyr)
library(tidyverse)
library(ggprism)
library(ggplot2)
library(Seurat)
library(data.table)

setwd(dirname(rstudioapi::getActiveDocumentContext()$path)) 
print(getwd())
```

```{r Preparation--Data Preprocessing}
## Object load-in
```{r}
# loading in necessary objects
```

```{r Fig 5b--rank plot}
source('HNC_ICB_GolfinosOwens_etal_2025/Visium_figures/Scripts/LR_Rank_Functions.R')

# Load in list from calculation step and merge them into a single dataframe
resultList <- readRDS(file = 'HNC_ICB_GolfinosOwens_etal_2025/Visium_figures/LR_boxplots/SCDC_LR_Comparison.rds')
allSamples <- do.call(rbind, args = resultList)
allSamples$score <- as.numeric(allSamples$score)

chemokineInteractions <- read.csv('HNC_ICB_GolfinosOwens_etal_2025/Visium_figures/ChemokineInteractions.csv')

# Filter to LR interactions with more than 2 samples per response group
result <- allSamples %>% 
  filter(sample_id != 'ck17_209') %>%
  group_by(LR_pair, response) %>%
  summarise(
    sample_count = n(),
    mean_value = mean(score),
    .groups = 'drop'
  ) %>%
  filter(sample_count >= 2) %>% 
  group_by(LR_pair) %>% 
  filter(n() == 2) %>%
  summarise(mean_diff = (diff(mean_value)), .groups = 'drop') %>%
  arrange(desc(mean_diff))

rankplot <- result %>% 
  mutate(rank = rank(desc(mean_diff))) %>%
  mutate(is_chemokine = grepl("^(CXCL16_CXCR6|CXCL9_CXCR3|CXCL10_CXCR3|CCL5_CCR5|CCL19_CCR7|CCL3_CCR5|CCL4_CCR5)", LR_pair)) %>%
  mutate(label = ifelse(is_chemokine, LR_pair, ''))

ggplot(data = rankplot, 
       aes(x = rank, y = mean_diff, 
           label = label,
           color = is_chemokine,
           size = is_chemokine,
           alpha = is_chemokine)) + 
  # Plot grey dots first
  geom_point(data = subset(rankplot, !is_chemokine)) +
  # Plot red dots second
  geom_point(data = subset(rankplot, is_chemokine)) +
  scale_color_manual(values = c("FALSE" = "grey", "TRUE" = "red")) +
  scale_size_manual(values = c("FALSE" = 2, "TRUE" = 3)) +
  scale_alpha_manual(values = c("FALSE" = 0.5, "TRUE" = 1)) +
  xlab('Ligand-Receptor Rank (Mean R vs NR Difference)') + 
  ylab('R-NR LR Mean CD45+ Spot Proportion') + 
  ggtitle('Mean Difference of CD45+ Spot LR Proportions (R-NR)') + 
  theme_classic() +
  # Plot labels last with increased repulsion
  geom_text_repel(data = subset(rankplot, is_chemokine), 
                  max.overlaps = Inf, 
                  show.legend = FALSE, 
                  force = 10,  # Increased force for more repulsion
                  nudge_x = 0.05,  # Slight horizontal nudge
                  nudge_y = 0.05,  # Slight vertical nudge
                  direction = 'both',
                  box.padding = 0.5,  # Increased padding around labels
                  point.padding = 0.5,  # Increased padding from points
                  segment.color = 'grey50') +  # Color of connecting lines
  theme_prism(base_size = 20) +
  theme(legend.position = "none")

ggsave('allInts_SCDC_LR_rank_mean_difference.pdf', width = 12, height = 8)

# chemokine only plot
rankplot_chemokine<-rankplot%>%filter(LR_pair %in% chemokineInteractions$pair)
rankplot_chemokine<-rankplot_chemokine%>%mutate(rank=rank(desc(mean_diff)))%>%mutate(label=case_when(rank<=10~LR_pair,
                                                                                                     rank>=dim(rankplot_chemokine)[1]-10~LR_pair,.default = ''))
top_n_diff <- 12
max_rank_diff <- max(rankplot_chemokine$rank)

pdf('SCDC_LR_rank_mean_difference.pdf', width = 12, height = 8)
ggplot(data = rankplot_chemokine, 
       aes(x = rank, 
           y = mean_diff, 
           label = ifelse(rank < top_n_diff + 1 | 
                            rank > max_rank_diff - top_n_diff | 
                            LR_pair == 'CXCL9_CXCR3', 
                          as.character(LR_pair), ''),
           color = ifelse(rank < top_n_diff + 1, "darkred",
                          ifelse(rank > max_rank_diff - top_n_diff, "darkblue", "black")))) + 
  geom_point() + 
  scale_color_identity() +
  xlab('Ligand-Receptor Rank (Mean R vs NR Difference)') + 
  ylab('R-NR LR Mean CD45+ Spot Proportion') + 
  ggtitle('Mean Difference of CD45+ Spot LR Proportions (R-NR)') + 
  theme_classic() +
  geom_text_repel(max.overlaps = 10, show.legend = FALSE, force = 3, direction = 'both') +
  theme_prism(base_size = 20)
dev.off()
```

```{r Fig 5c--score by patient boxplot}
source('HNC_ICB_GolfinosOwens_etal_2025/Visium_figures/Scripts/LR_Rank_Functions.R')

setwd(dirname(rstudioapi::getActiveDocumentContext()$path)) 

SpatialFeaturePlot(ck17_5, features = c('CXCL9', 'CXCL10', 'CXCR3'), pt.size.factor = 2500, keep.scale = 'all')
ggsave('ck17_5_SpatialFeaturePlot_CXCL9_CXCL10_CXCR3.pdf')

SpatialFeaturePlot(ck17_7, features = c('CXCL9', 'CXCL10', 'CXCR3'), pt.size.factor = 2500, keep.scale = 'all')
ggsave('ck17_7_SpatialFeaturePlot_CXCL9_CXCL10_CXCR3.pdf')

SpatialFeaturePlot(ck17_5, features = c('CXCL16', 'CXCR6'), pt.size.factor = 2500, keep.scale = 'all')
ggsave('ck17_5_SpatialFeaturePlot_CXCL16_CXCR6.pdf')

SpatialFeaturePlot(ck17_7, features = c('CXCL16', 'CXCR6'), pt.size.factor = 2500, keep.scale = 'all')
ggsave('ck17_7_SpatialFeaturePlot_CXCL16_CXCR6.pdf')
```

ck17_5 <- readRDS('HNC_ICB_GolfinosOwens_etal_2025/objects/ck17_5_perspotScore.rds')
ck17_7 <- readRDS('HNC_ICB_GolfinosOwens_etal_2025/objects/ck17_7_perspotScore.rds')

SpatialFeaturePlot(ck17_5, features = c('CXCL9-CXCR3_nhScore', 'CXCL10-CXCR3_nhScore', 'CXCL16-CXCR6_nhScore'), pt.size.factor = 2500, keep.scale = 'all')
ggsave('ck17_5_SpatialFeaturePlot_SCORE_CXCL9_CXCL10_CXCR3_CXCL16_CXCR6.pdf', width = 12)

SpatialFeaturePlot(ck17_7, features = c('CXCL9-CXCR3_nhScore', 'CXCL10-CXCR3_nhScore', 'CXCL16-CXCR6_nhScore'), pt.size.factor = 2500, keep.scale = 'all')
ggsave('ck17_7_SpatialFeaturePlot_SCORE_CXCL9_CXCL10_CXCR3_CXCL16_CXCR6.pdf', width = 12)


# Print the current working directory (optional, for verification) 
print(getwd())
seurat_list=list(ck17_1294=ck17_1294,
                 ck17_12e6=ck17_12e6,
                 ck17_1592=ck17_1592,
                 ck17_19=ck17_19,
                 ck17_208=ck17_208,
                 ck17_25=ck17_25,
                 ck17_5=ck17_5,
                 ck17_7=ck17_7)

SCDC_ComparmentDeconvolution<-read.csv('HNC_ICB_GolfinosOwens_etal_2025/Visium_figures/SCDC_compartment_proportions.csv',row.names = 1)
SCDCPivot<-SCDC_ComparmentDeconvolution%>%pivot_wider(id_cols=c(Barcode,Sample_Name,Response),names_from = Cell_Type,values_from = Proportion)
pivot_Filtered=SCDCPivot%>%filter(!Sample_Name %in% c('ck17_27','ck17_21'))
cellchat_pairs <- read.csv('HNC_ICB_GolfinosOwens_etal_2025/Visium_figures/Reference/cellchat_LR_pairs.csv')
ligands = cellchat_pairs$ligand
receptors = cellchat_pairs$receptor

(pivot_Filtered%>%filter(Sample_Name==n)%>%select(CD45pos))$CD45pos

resultList=list()
i=1
for (n in names(seurat_list)){
  objRank<-lr_rank_new(ligands=ligands,receptors = receptors,object = seurat_list[[n]],object_name = n,cellTypeVec = (pivot_Filtered%>%filter(Sample_Name==n)%>%select(CD45pos))$CD45pos)
  resultList[[i]]=objRank
  i<-i+1
}
names(resultList)<-names(seurat_list)
saveRDS(resultList,file = 'HNC_ICB_GolfinosOwens_etal_2025/Visium_figures/LR_boxplots/SCDC_LR_Comparison.rds')

#Load in list from calculation step and merge them into a single dataframe
resultList<-readRDS(file = 'HNC_ICB_GolfinosOwens_etal_2025/Visium_figures/LR_boxplots/SCDC_LR_Comparison.rds')
allSamples<-do.call(rbind,args = resultList)
allSamples$score=as.numeric(allSamples$score)

chemokineInteractions<-read.csv('HNC_ICB_GolfinosOwens_etal_2025/Visium_figures/ChemokineInteractions.csv')

#Filter to LR interactions with more than 2 samples per response group
result <- allSamples %>% 
  filter(sample_id!='ck17_209') %>%
  group_by(LR_pair, response) %>%
  # Count samples and calculate mean, keep only those with exactly 2 samples
  summarise(
    sample_count = n(),
    mean_value = mean(score),
    .groups = 'drop'
  ) %>%
  filter(sample_count>=2) %>% 
  group_by(LR_pair) %>% 
  filter(n()==2) %>%
  summarise(mean_diff=(diff(mean_value)),.groups = 'drop') %>%
  arrange(desc(mean_diff))



g1 <- ggplot(data = allSamples%>%filter(LR_pair=='CXCL9_CXCR3'),aes(x=response,y=score,fill=response, color=response), alpha = 0.5) + 
  geom_boxplot(aes(x=response,y=score,fill=response, color=response), alpha = 0.5, outlier.size = 0) + 
  geom_jitter() + stat_compare_means() + 
  facet_wrap(~LR_pair) +
  geom_point(aes(x=response,y=score,fill=response, color=response), alpha = 0.8) +
  theme_bw() +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(), 
        axis.title.x = element_blank(), 
        strip.text = element_text(size = 12)) + 
  scale_shape_manual(values = 1:5) + 
  theme(legend.key.size = unit(1, 'cm'), 
        legend.title = element_text(size=30), 
        legend.text = element_text(size=20), 
        axis.text = element_text(size=16),
        axis.title = element_text(size=12), 
        legend.position = 'none') + 
  scale_fill_manual(name='ICB\nResponse',values = c('#2196F3', '#FF8A80')) + #+ ggtitle('Proportion of CXCL9+CXCR3+ Spots Among CD45+ Spots') +
  scale_color_manual(values = c('#2196F3', '#FF8A80')) +
  ylab('Proportion of LR spots among CD45+ spots')+xlab('ICB Response')

g2 <- ggplot(data = allSamples%>%filter(LR_pair=='CXCL10_CXCR3'),aes(x=response,y=score,fill=response, color=response), alpha = 0.5) + 
  geom_boxplot(aes(x=response,y=score,fill=response, color=response), alpha = 0.5, outlier.size = 0) + 
  geom_jitter() + stat_compare_means() + 
  facet_wrap(~LR_pair) +
  geom_point(aes(x=response,y=score,fill=response, color=response), alpha = 0.8) +
  theme_bw() +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(), 
        axis.title.x = element_blank(), 
        strip.text = element_text(size = 12)) + 
  scale_shape_manual(values = 1:5) + 
  theme(legend.key.size = unit(1, 'cm'), 
        legend.title = element_text(size=30), 
        legend.text = element_text(size=20), 
        axis.text = element_text(size=16),
        axis.title = element_text(size=12), 
        legend.position = 'none') + 
  scale_fill_manual(name='ICB\nResponse',values = c('#2196F3', '#FF8A80')) + #+ ggtitle('Proportion of CXCL10+CXCR3+ Spots Among CD45+ Spots') +
  scale_color_manual(values = c('#2196F3', '#FF8A80')) +
  ylab('Proportion of LR spots among CD45+ spots')+xlab('ICB Response')

g3 <- ggplot(data = allSamples%>%filter(LR_pair=='CXCL16_CXCR6'),aes(x=response,y=score,fill=response, color=response), alpha = 0.5) + 
  geom_boxplot(aes(x=response,y=score,fill=response, color=response), alpha = 0.5, outlier.size = 0) + 
  geom_jitter() + stat_compare_means() + 
  geom_point(aes(x=response,y=score,fill=response, color=response), alpha = 0.8) +
  facet_wrap(~LR_pair) +
  theme_bw() +
  theme(axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(), 
        axis.title.x = element_blank(), 
        strip.text = element_text(size = 12)) + 
  scale_shape_manual(values = 1:5) + 
  theme(legend.key.size = unit(1, 'cm'), 
        legend.title = element_text(size=30), 
        legend.text = element_text(size=20), 
        axis.text = element_text(size=16),
        axis.title = element_text(size=12), 
        legend.position = 'none') + 
  scale_fill_manual(name='ICB\nResponse',values = c('#2196F3', '#FF8A80')) + #+ ggtitle('Proportion of CXCL16+CXCR6+ Spots Among CD45+ Spots') +
  scale_color_manual(values = c('#2196F3', '#FF8A80')) +
  ylab('Proportion of LR spots among CD45+ spots')+xlab('ICB Response')

pdf('CXCL9_10_CXCR3_CXCL16_CXCR6_prop_LRposCD45pos_spots.pdf', width = 7, height = 4)
cowplot::plot_grid(g1, g2, g3, nrow = 1)
dev.off()
```

